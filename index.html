<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Solitaire (Klondike)</title>
  <style>
    body { background:#0b6623; color:#fff; font-family:sans-serif; }
    .board { display:flex; flex-direction:column; gap:20px; padding:20px; }
    .row { display:flex; gap:12px; }
    .pile {
	  width:80px;
	  min-height:110px;   /* â­ height â†’ min-height */
	  border:1px solid rgba(255,255,255,0.3);
	  border-radius:6px;
	  position:relative;
	}
    .card {
	  width:80px;
	  height:110px;
	  border-radius:6px;
	  background:#fff;
	  position:absolute;
	  cursor:pointer;
	  outline: 1px solid black;
	  cursor: grab;
	}
	
	.card:active {
	  cursor: grabbing;
	}

	.card .label {
	  position:absolute;
	  top:6px;
	  left:6px;
	  font-size:14px;
	  font-weight:bold;
	  color: #000;
	}

	.red .label {
	  color:red;
	}

    .red { color:red; }
    .back { background:#1e90ff; }
	.selected {
	  outline: 3px solid gold;
	  outline-offset: -3px;
	}
	
	@keyframes firework {
	  0% {
		transform: translate(0,0) rotate(0deg);
		opacity: 1;
	  }
	  100% {
		transform:
		  translate(
			calc((Math.random() - 0.5) * 600px),
			-600px
		  )
		  rotate(720deg);
		opacity: 0;
	  }
	}

	.firework {
	  animation: firework 1.2s ease-out forwards;
	}
	
  </style>
</head>
<body>
  <h1>ğŸƒ ì†”ë¦¬í…Œì–´ (í´ë¡ ë‹¤ì´í¬)</h1>
  <div class="board">
    <div class="row" id="top">
      <div class="pile" id="stock"></div>
      <div class="pile" id="waste"></div>
      <div style="flex:1"></div>
      <div class="pile foundation" data-suit="â™ "></div>
      <div class="pile foundation" data-suit="â™¥"></div>
      <div class="pile foundation" data-suit="â™¦"></div>
      <div class="pile foundation" data-suit="â™£"></div>
    </div>
    <div class="row" id="tableau"></div>
  </div>
  
  <!-- ìŠ¹ë¦¬ ì˜¤ë²„ë ˆì´ UI -->
  <div id="winOverlay" style="
	  display:none;
	  position:fixed;
	  inset:0;
	  background:rgba(0,0,0,0.6);
	  z-index:999;
	  color:#fff;
	  font-size:48px;
	  font-weight:bold;
	  align-items:center;
	  justify-content:center;
	  flex-direction:column;
	">
	  ğŸ‰ CLEAR!
	  <button onclick="location.reload()" style="
		margin-top:20px;
		font-size:18px;
		padding:10px 20px;
		cursor:pointer;
	  ">ë‹¤ì‹œí•˜ê¸°</button>
	</div>
<script>
const suits = ['â™ ','â™¥','â™¦','â™£'];
const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
let deck = [];
let stock = [], waste = [];
let tableau = [[],[],[],[],[],[],[]];
let history = []; // ì „ì²´ ìƒíƒœ ì €ì¥ìš©
let cardId = 0;
let foundations = {
  'â™ ': [],
  'â™¥': [],
  'â™¦': [],
  'â™£': []
};

//ë± ìƒì„±
function createDeck() {
  deck = [];
  for (let s of suits) {
    for (let v of values) {
      deck.push({
        id: cardId++,   // â­ ê³ ìœ  ID
        suit: s,
        value: v,
        faceUp: false
      });
    }
  }
  deck.sort(() => Math.random() - 0.5);
}

//ì¹´ë“œë°°ì¹˜
function deal() {
  for (let i=0;i<7;i++) {
    for (let j=0;j<=i;j++) {
      const card = deck.pop();
      if (j === i) card.faceUp = true;
      tableau[i].push(card);
    }
  }
  stock = deck;
}

function render() {
  document.getElementById('stock').innerHTML = '';
  document.getElementById('waste').innerHTML = '';

  // stock
  if (stock.length || waste.length) {
	  const c = document.createElement('div');
	  c.className = 'card back';
	  c.onclick = drawCard;
	  document.getElementById('stock').appendChild(c);
	}

  // waste
  if (waste.length) {
    const card = waste[waste.length-1];
    document.getElementById('waste')
      .appendChild(cardEl(card, {type:'waste'}));
  }

  /* =====================
     tableau ë Œë”
     ===================== */
  const tab = document.getElementById('tableau');
  tab.innerHTML = '';

  tableau.forEach((col, colIdx) => {
	  const p = document.createElement('div');
	  p.className = 'pile';

	  let topOffset = 0; // â­â­â­ ì—¬ê¸°! ì»¬ëŸ¼ë§ˆë‹¤ ì´ˆê¸°í™”

	  p.onclick = (e) => {
		if (e.target !== p) return;
		onPileClick({ type:'tableau', index:colIdx });
	  };
	    // ğŸ”½ ë“œë˜ê·¸ í—ˆìš© (í•„ìˆ˜)
	  p.ondragover = (e) => {
		e.preventDefault(); // ì´ê±° ì—†ìœ¼ë©´ drop ì•ˆë¨
	  };

	  // ğŸ”½ ë“œë¡­ ì‹œ ì´ë™
	  p.ondrop = (e) => {
		e.preventDefault();
		onPileClick({ type:'tableau', index:colIdx });
	  };

	  col.forEach((card) => {
		const el = cardEl(card, { type:'tableau', index:colIdx });

		if (!card.faceUp) {
		  el.style.top = topOffset + 'px';
		  topOffset += 20;   // ë’¤ì§‘íŒ ì¹´ë“œ
		} else {
		  el.style.top = topOffset + 'px';
		  topOffset += 30;   // í¼ì³ì§„ ì¹´ë“œ
		}

		p.appendChild(el);
	  });

	  tab.appendChild(p);
	});


  /* =====================
     foundation ë Œë”
     ===================== */
  document.querySelectorAll('.foundation').forEach(f => {
	  const suit = f.dataset.suit;
	  f.innerHTML = '';

	  const pile = foundations[suit];

	  if (pile.length) {
		const card = pile[pile.length - 1];
		f.appendChild(cardEl(card, { type:'foundation', suit }));
	  } else {
		// â­ ë¬´ëŠ¬ í‘œì‹œ
		const hint = document.createElement('div');
		hint.style.position = 'absolute';
		hint.style.inset = '0';
		hint.style.display = 'flex';
		hint.style.alignItems = 'center';
		hint.style.justifyContent = 'center';
		hint.style.fontSize = '36px';
		hint.style.opacity = '0.3';
		hint.textContent = suit;
		f.appendChild(hint);
	  }

	  f.onclick = () =>
		onFoundationClick({ type:'foundation', suit });
	});
	
	// ë§ˆì§€ë§‰ì— ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
	updateAutoCompleteButton();
	createUndoButton(); // í•­ìƒ ë²„íŠ¼ ìƒì„±
}

//ì¹´ë“œ ìŒ“ê¸°
function cardEl(card, fromInfo) {
  const d = document.createElement('div');
  d.className = 'card ' + ((card.suit==='â™¥'||card.suit==='â™¦')?'red':'');

  if (!card.faceUp) d.classList.add('back');

  if (card.faceUp) {
    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = card.value + card.suit;
    d.appendChild(label);
  }

  // ğŸ–± ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
  d.onclick = (e) => { ... };
  d.ondblclick = (e) => { ... };
  d.ondragstart = (e) => { ... };

  // âœ… ì—¬ê¸°ì— ë°”ë¡œ í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
  d.ontouchstart = (e) => {
    e.preventDefault();
    selectedCard = card;
    selectedFrom = fromInfo;
    const touch = e.touches[0];
    d.startX = touch.clientX;
    d.startY = touch.clientY;
  };

  d.ontouchmove = (e) => {
    if (!selectedCard) return;
    const touch = e.touches[0];
    const dx = touch.clientX - d.startX;
    const dy = touch.clientY - d.startY;
    d.style.transform = `translate(${dx}px, ${dy}px)`;
  };

  d.ontouchend = (e) => {
    if (!selectedCard) return;
    const touch = e.changedTouches[0];
    const el = document.elementFromPoint(touch.clientX, touch.clientY);

    if (!el) {
      selectedCard = null;
      selectedFrom = null;
      render();
      return;
    }

    if (el.classList.contains('pile')) {
      onPileClick({ type: 'tableau', index: Array.from(el.parentNode.children).indexOf(el) });
    } else if (el.classList.contains('foundation')) {
      onFoundationClick({ type: 'foundation', suit: el.dataset.suit });
    }

    selectedCard = null;
    selectedFrom = null;
    render();
  };

  // ì¹´ë“œ ì„ íƒ í‘œì‹œ
  if (selectedCard && selectedCard.id === card.id) {
    d.classList.add('selected');
  }

  return d;
}

//ì¹´ë“œ ë½‘ê¸°
function drawCard() {
  if (!stock.length) {
    if (!waste.length) return;

    while (waste.length) {
      const c = waste.pop();
      c.faceUp = false;
      stock.push(c);
    }
  } else {
    const c = stock.pop();
    c.faceUp = true;
    waste.push(c);
  }
  render();
}

let selectedCard = null;
let selectedFrom = null;

function valueNum(v) {
  return values.indexOf(v);
}

//ì¹´ë“œ ë†“ëŠ” ê·œì¹™
function canMove(card, from, to) {
  if (to.type === 'tableau') {
    const col = tableau[to.index];

    if (col.length === 0) return card.value === 'K';

    const top = col[col.length - 1];
    const diffColor =
      (['â™¥','â™¦'].includes(card.suit)) !==
      (['â™¥','â™¦'].includes(top.suit));

    return diffColor &&
      valueNum(card.value) === valueNum(top.value) - 1;
  }
  return false;
}

//ì¹´ë“œ ì„ íƒ
function onCardClick(card, from) {
  if (!card.faceUp) return;

  // 1ï¸âƒ£ ì„ íƒ
  if (!selectedCard) {
    selectedCard = card;
    selectedFrom = from;
    render(); // â­ ì¤‘ìš”
    return;
  }

  // 2ï¸âƒ£ ê°™ì€ ì¹´ë“œ / ê°™ì€ ì»¬ëŸ¼ì´ë©´ ì·¨ì†Œ
  if (
    from.type === 'tableau' &&
    selectedFrom.type === 'tableau' &&
    from.index === selectedFrom.index
  ) {
    selectedCard = null;
    selectedFrom = null;
    render();
    return;
  }

  // 3ï¸âƒ£ ë‹¤ë¥¸ ì»¬ëŸ¼ ì¹´ë“œ í´ë¦­ â†’ ì´ë™ ì‹œë„
  if (from.type === 'tableau') {
    onPileClick({ type:'tableau', index: from.index });
  }
  
  // foundation ì¹´ë“œ í´ë¦­ ì‹œ ì´ë™ ì‹œë„
  if (from.type === 'foundation') {
    onFoundationClick({ type:'foundation', suit: from.suit });
  }
}

function onPileClick(to) {
  if (!selectedCard) return;
  
  saveHistory(); // â­ ì´ë™ ì „ì— ìƒíƒœ ì €ì¥

  const stack = getMoveStack();
  if (canMove(stack[0], selectedFrom, to)) {

    // ğŸ”¹ ì¶œë°œì§€ ì œê±°
    if (selectedFrom.type === 'tableau') {
      const col = tableau[selectedFrom.index];
      col.splice(col.length - stack.length, stack.length);

      if (col.length && !col[col.length - 1].faceUp) {
        col[col.length - 1].faceUp = true;
      }
    }

    // ğŸ”¹ waste â†’ tableau (1ì¥)
    if (selectedFrom.type === 'waste') {
      waste.pop();
    }
	
	// â­ foundation â†’ tableau ì´ë™ ì²˜ë¦¬
    if (selectedFrom.type === 'foundation') {
      const pile = foundations[selectedFrom.suit];
      pile.pop();  // ë§ˆì§€ë§‰ ì¹´ë“œ ì œê±°
    }
	
    // ğŸ”¹ ëª©ì ì§€ì— ì—¬ëŸ¬ ì¥ ì¶”ê°€
    tableau[to.index].push(...stack);
  }

  selectedCard = null;
  selectedFrom = null;
  render();
}

//foundation ê·œì¹™ í•¨ìˆ˜
function canMoveToFoundation(card, to) {
  const pile = foundations[to.suit];

  // ë¹ˆ foundation â†’ Aë§Œ ê°€ëŠ¥
  if (pile.length === 0) {
	return card.value === 'A' && card.suit === to.suit;
  }

  const top = pile[pile.length - 1];
  return (
    card.suit === to.suit &&
    valueNum(card.value) === valueNum(top.value) + 1
  );
}

//foundation í´ë¦­ ì²˜ë¦¬
function onFoundationClick(to) {
  if (!selectedCard) return;

  if (canMoveToFoundation(selectedCard, to)) {

    // ğŸ”¹ ì¶œë°œì§€ ì œê±°
    if (selectedFrom.type === 'tableau') {
      const col = tableau[selectedFrom.index];
      col.pop();

      if (col.length && !col[col.length - 1].faceUp) {
        col[col.length - 1].faceUp = true;
      }
    }

    if (selectedFrom.type === 'waste') {
      waste.pop();
    }

    // ğŸ”¹ foundationì— ì¶”ê°€
    foundations[to.suit].push(selectedCard);
	checkWin();
  }

  selectedCard = null;
  selectedFrom = null;
  render();  
}

//ì„ íƒ ì¹´ë“œ ìœ„ì¹˜ ì°¾ê¸°
function getMoveStack() {
  if (selectedFrom.type !== 'tableau') {
    return [selectedCard];
  }

  const col = tableau[selectedFrom.index];
  const idx = col.findIndex(c => c.id === selectedCard.id);

  return col.slice(idx);
}

function saveHistory() {
  // ê¹Šì€ ë³µì‚¬ í•„ìš” (deck, tableau, waste, foundations)
  const state = {
    tableau: tableau.map(col => col.map(c => ({...c}))),
    waste: waste.map(c => ({...c})),
    foundations: {
      'â™ ': foundations['â™ '].map(c => ({...c})),
      'â™¥': foundations['â™¥'].map(c => ({...c})),
      'â™¦': foundations['â™¦'].map(c => ({...c})),
      'â™£': foundations['â™£'].map(c => ({...c})),
    }
  };
  history.push(state);
}

function createUndoButton() {
  let btn = document.getElementById('undoBtn');
  if (!btn) {
    btn = document.createElement('button');
    btn.id = 'undoBtn';
    btn.textContent = 'â†©ï¸ ì‹¤í–‰ì·¨ì†Œ';
    btn.style.position = 'fixed';
    btn.style.bottom = '20px';
    btn.style.right = '20px';
    btn.style.zIndex = '1000';
    btn.style.padding = '10px 16px';
    btn.style.fontSize = '14px';
    btn.onclick = undoMove;
    document.body.appendChild(btn);
  }
}

function undoMove() {
  if (!history.length) return;

  const prev = history.pop();

  tableau = prev.tableau.map(col => col.map(c => ({...c})));
  waste = prev.waste.map(c => ({...c}));
  foundations = {
    'â™ ': prev.foundations['â™ '].map(c => ({...c})),
    'â™¥': prev.foundations['â™¥'].map(c => ({...c})),
    'â™¦': prev.foundations['â™¦'].map(c => ({...c})),
    'â™£': prev.foundations['â™£'].map(c => ({...c})),
  };

  selectedCard = null;
  selectedFrom = null;

  render();
}

//ìë™ ì´ë™
function autoMoveToFoundation(card, from) {
  if (!card.faceUp) return;

  for (let suit of suits) {
    const to = { type:'foundation', suit };

    if (canMoveToFoundation(card, to)) {

      // ì¶œë°œì§€ ì œê±°
      if (from.type === 'tableau') {
        const col = tableau[from.index];
        col.pop();

        if (col.length && !col[col.length - 1].faceUp) {
          col[col.length - 1].faceUp = true;
        }
      }

      if (from.type === 'waste') {
        waste.pop();
      }

      foundations[suit].push(card);
      selectedCard = null;
      selectedFrom = null;
      render();
      return;
    }
  }
}

function allCardsFaceUp() {
  // tableau ëª¨ë“  ì¹´ë“œ í™•ì¸
  const tableauUp = tableau.flat().every(c => c.faceUp);
  // waste ì¹´ë“œ í™•ì¸
  const wasteUp = waste.every(c => c.faceUp);
  // stockì€ ê¸°ë³¸ì ìœ¼ë¡œ ë’¤ì§‘í˜€ ìˆìŒ â†’ stockì´ ë¹„ì–´ ìˆìœ¼ë©´ ì‹ ê²½ ì•ˆ ì¨ë„ ë¨
  return tableauUp && wasteUp;
}

function updateAutoCompleteButton() {
  let btn = document.getElementById('autoCompleteBtn');
  
  if (!btn) {
    btn = document.createElement('button');
    btn.id = 'autoCompleteBtn';
    btn.textContent = 'ğŸ§ª ìë™ì™„ì„±';
    btn.style.position = 'fixed';
    btn.style.top = '20px';
    btn.style.right = '20px';
    btn.style.zIndex = '1000';
    btn.style.padding = '10px 16px';
    btn.style.fontSize = '14px';
    btn.onclick = autoComplete; // í´ë¦­ ì‹œ ìë™ì™„ì„± ì‹¤í–‰
    document.body.appendChild(btn);
  }

  // ëª¨ë“  ì¹´ë“œê°€ ì•ë©´ì´ë©´ í‘œì‹œ, ì•„ë‹ˆë©´ ìˆ¨ê¹€
  btn.style.display = allCardsFaceUp() ? 'block' : 'none';
}


//ìë™ ì™„ì„±
function autoComplete() {
  let moved;

  do {
    moved = false;

    // 1ï¸âƒ£ tableau â†’ foundation
    tableau.forEach((col, colIdx) => {
      if (!col.length) return;
      const card = col[col.length - 1]; // ë§¨ ìœ„ ì¹´ë“œ
      for (let suit of suits) {
        const target = { type: 'foundation', suit };
        if (canMoveToFoundation(card, target)) {
          col.pop();
          foundations[suit].push(card);
          moved = true;
          if (col.length && !col[col.length - 1].faceUp)
            col[col.length - 1].faceUp = true;
        }
      }
    });

    // 2ï¸âƒ£ waste â†’ foundation
    if (waste.length) {
      const card = waste[waste.length - 1];
      for (let suit of suits) {
        const target = { type: 'foundation', suit };
        if (canMoveToFoundation(card, target)) {
          waste.pop();
          foundations[suit].push(card);
          moved = true;
        }
      }
    }

    render();
  } while (moved);

  checkWin(); // âœ… ëë‚˜ë©´ WIN ì²´í¬
}

//ìŠ¹ë¦¬ ì¡°ê±´
function checkWin() {
  const total =
    foundations['â™ '].length +
    foundations['â™¥'].length +
    foundations['â™¦'].length +
    foundations['â™£'].length;

  if (total === 52) {
    showWin();
  }
}

//ì¹´ë“œ í­ì£½
function cardFirework() {
  const cards = document.querySelectorAll('.card');

  cards.forEach(card => {
    const rect = card.getBoundingClientRect();

    // ğŸ”¥ body ê¸°ì¤€ìœ¼ë¡œ ì´ë™
    card.style.position = 'fixed';
    card.style.left = rect.left + 'px';
    card.style.top = rect.top + 'px';
    card.style.margin = '0';
    card.style.zIndex = '9999';

    document.body.appendChild(card);

    const x = (Math.random() - 0.5) * window.innerWidth;
    const y = -window.innerHeight - Math.random() * 300;
    const r = Math.random() * 720 - 360;

    requestAnimationFrame(() => {
      card.style.transition = 'transform 1.3s ease-out, opacity 1.3s';
      card.style.transform = `translate(${x}px, ${y}px) rotate(${r}deg)`;
      card.style.opacity = '0';
    });
  });
}

//ìŠ¹ë¦¬ í‘œì‹œ
function showWin() {
  cardFirework();   // ğŸ† ë¨¼ì € í„°íŠ¸ë¦¬ê³ 

  const o = document.getElementById('winOverlay');
  o.style.display = 'flex';

  document.body.style.pointerEvents = 'none';
  o.style.pointerEvents = 'auto';
}


//í…ŒìŠ¤íŠ¸
function forceWin() {
  // ëª¨ë“  ì¹´ë“œ ìˆ˜ì§‘
  const allCards = [
    ...stock,
    ...waste,
    ...tableau.flat(),
    ...foundations['â™ '],
    ...foundations['â™¥'],
    ...foundations['â™¦'],
    ...foundations['â™£']
  ];

  // ì´ˆê¸°í™”
  stock = [];
  waste = [];
  tableau = [[],[],[],[],[],[],[]];
  foundations = { 'â™ ':[], 'â™¥':[], 'â™¦':[], 'â™£':[] };

  // foundationì— ì •ë ¬í•´ì„œ ë„£ê¸°
  allCards.forEach(c => {
    c.faceUp = true;
    foundations[c.suit].push(c);
  });

  render();
  checkWin();
}


createDeck();
deal();
render();
</script>
</body>
</html>
